/*
main.c
Carlos Ojeda de Silva
cojedadesilva@g.hmc.edu
This code uses timer 2 to control music being played with a speaker, where notes is an array of frequencies and durations of these notes.
*/
#include <stdint.h>
#include "Lab4h.h"

#define Speakerpin      3

const int notes[][2] = {
{659,	125},{623,	125},{659,	125},{623,	125},{659,	125},{494,	125},{587,	125},{523,	125},
{440,	250},{  0,	125},{262,	125},{330,	125},{440,	125},{494,	250},{  0,	125},{330,	125},
{416,	125},{494,	125},{523,	250},{  0,	125},{330,	125},{659,	125},{623,	125},{659,	125},
{623,	125},{659,	125},{494,	125},{587,	125},{523,	125},{440,	250},{  0,	125},{262,	125},
{330,	125},{440,	125},{494,	250},{  0,	125},{330,	125},{523,	125},{494,	125},{440,	250},
{  0,	125},{494,	125},{523,	125},{587,	125},{659,	375},{392,	125},{699,	125},{659,	125},
{587,	375},{349,	125},{659,	125},{587,	125},{523,	375},{330,	125},{587,	125},{523,	125},
{494,	250},{  0,	125},{330,	125},{659,	125},{  0,	250},{659,	125},{1319,	125},{  0,	250},
{623,	125},{659,	125},{  0,	250},{623,	125},{659,	125},{623,	125},{659,	125},{623,	125},
{659,	125},{494,	125},{587,	125},{523,	125},{440,	250},{  0,	125},{262,	125},{330,	125},
{440,	125},{494,	250},{  0,	125},{330,	125},{416,	125},{494,	125},{523,	250},{  0,	125},
{330,	125},{659,	125},{623,	125},{659,	125},{623,	125},{659,	125},{494,	125},{587,	125},
{523,	125},{440,	250},{  0,	125},{262,	125},{330,	125},{440,	125},{494,	250},{  0,	125},
{330,	125},{523,	125},{494,	125},{440,	500},

{440,	500},{0,	40},{440,	80},{0,	40},

{440,	80},{659,	160},{880,	160},{659,	80},
{523,	160},{1046,	120},{0,	40},{1046,	120},{0,	40},{988,	120},{0,	40},{1046,	160},
{349,	80},{440,	160},{698,	160},{523,	80},
{440,	160},{880,	120},{0,	40},{880,	120},{0,	40},{784,	120},{0,	40},{784,	160},
{523,	80},{784,	160},{1026,	160},{784,	80},
{659,	160},{1319,	120},{0,	40},{1319,	120},{0,	40},{1175,	120},{0,	40},{1175,	160},
{494,	80},{587,	160},{784,	160},{587,	80},
{494,	160},{988,	120},{0,	40},{988,	120},{0,	40},{988,	120},{0,	40},{1026,	160}, 
{440,	80},{659,	160},{880,	160},{659,	80},
{523,	160},{1046,	120},{0,	40},{1046,	120},{0,	40},{988,	120},{0,	40},{1046,	160},
{349,	80},{440,	160},{698,	160},{523,	80},
{440,	160},{880,	120},{0,	40},{880,	120},{0,	40},{784,	120},{0,	40},{784,	160},
{523,	80},{784,	160},{1026,	160},{784,	80},
{659,	160},{1319,	120},{0,	40},{1319,	120},{0,	40},{1175,	120},{0,	40},{1175,	160},
{494,	80},{587,	160},{784,	160},{587,	80},
{494,	160},{988,	120},{0,	40},{988,	120},{0,	40},{988,	120},{0,	40},{1026,	160},//*/
{0, 0}
};

/* Danza Kuduro by Carlos Ojeda
const int notes[][2] = {
{0,	800}, {440,	160},{659,	320},{880,	320},{659,	160},
{523,	320},{1046,	240},{0,	40},{1046,	240},{0,	40},{988,	240},{0,	40},{1046,	320},
{349,	160},{440,	320},{698,	320},{523,	160},
{440,	320},{880,	240},{0,	40},{880,	240},{0,	40},{784,	240},{0,	40},{784,	320},
{523,	160},{784,	320},{1026,	320},{784,	160},
{659,	320},{1319,	240},{0,	40},{1319,	240},{0,	40},{1175,	240},{0,	40},{1175,	320},
{494,	160},{587,	320},{784,	320},{587,	160},
{494,	320},{988,	240},{0,	40},{988,	240},{0,	40},{988,	240},{0,	40},{1026,	320}, 
{440,	160},{659,	320},{880,	320},{659,	160},
{523,	320},{1046,	240},{0,	40},{1046,	240},{0,	40},{988,	240},{0,	40},{1046,	320},
{349,	160},{440,	320},{698,	320},{523,	160},
{440,	320},{880,	240},{0,	40},{880,	240},{0,	40},{784,	240},{0,	40},{784,	320},
{523,	160},{784,	320},{1026,	320},{784,	160},
{659,	320},{1319,	240},{0,	40},{1319,	240},{0,	40},{1175,	240},{0,	40},{1175,	320},
{494,	160},{587,	320},{784,	320},{587,	160},
{494,	320},{988,	240},{0,	40},{988,	240},{0,	40},{988,	240},{0,	40},{1026,	320}, 
{0, 0}};
*/

void delayf(uint32_t cycles) {
    TIM2->ARR = 2000000/(1000*(40))-1; //for 1000 Hz, precise ms delay
    TIM2->CNT = 0;
    for (uint32_t i = 1; i <= cycles; i++) {
        while (!(TIM2->SR & 1)){}  //UIF 
        TIM2->SR &= ~(1<<0); 
    }
}

void freqf(int freq, int cycles) {
    TIM2->ARR = 2000000/(freq*(40))-1; //for up to 10,000/2 Hz, precise delay
    TIM2->CNT = 0;
    for (uint32_t i = 1; i <= cycles; i++) {
        while (!(TIM2->SR & 1)){}  //UIF 
        TIM2->SR &= ~(1<<0); 
        GPIOB->ODR ^= (1 << Speakerpin);
    }
}

int main(void) {
    int i = 0;
    // RCC
    RCC->AHB2ENR |= (1 << 1);
    RCC->APB1ENR1 |= (1 << 0);


    GPIOB->MODER &= ~(3 << (Speakerpin * 2)); //enables Speakerpin to be output
    GPIOB->MODER |=  (1 << (Speakerpin * 2));

    TIM2->PSC = 39;     // Timer 2, 4Using PSC as a constant since it was recommended.
    TIM2->CR1 |= 1;     // Enable counter

    //Checks if both the duratrion and frequency does not equal zero as thta implies trhye ending
    while(!(notes[i][0] == 0 && notes[i][1] == 0)){
      int freq = notes[i][0];
      int delay = notes[i][1];
      if (freq == 0) {
        delayf(delay*2); // skip note playing
    } else{
        uint32_t cycles = freq*delay/500; //500 since 1000ms/s and we want a half cycle
        delayf(5);
        freqf(freq, cycles);
    }
      i++;
      GPIOB->ODR = ~(1 << Speakerpin);
    }
} 
